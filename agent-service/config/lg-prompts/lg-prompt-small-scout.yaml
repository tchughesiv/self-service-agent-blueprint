# State Machine Configuration for Laptop Refresh Agent
# Each state defines its behavior, prompts, and transition conditions

# Global settings
settings:
  initial_state: "lookup_employee"
  terminator_env_var: "AGENT_MESSAGE_TERMINATOR"
  agent_name: "laptop-refresh"
  terminal_state: "end"
  empty_response_retry_count: 3

# State structure definition - completely configurable
state_schema:
  # Business logic fields
  business_fields:
    employee_info:
      type: "dict"
      description: "Employee information from lookup"
      default: null
    laptop_eligibility:
      type: "dict"
      description: "Laptop refresh eligibility assessment"
      default: null
    eligibility_status:
      type: "string"
      description: "Eligibility classification result (ELIGIBLE, NOT, UNCLEAR)"
      default: null
    selected_laptop:
      type: "string"
      description: "User's selected laptop model"
      default: null
    selected_laptop_details:
      type: "dict"
      description: "Full details of the selected laptop"
      default: null
    laptop_options:
      type: "dict"
      description: "Available laptop options shown to user"
      default: null
    laptop_options_retry_count:
      type: "integer"
      description: "Number of times we've retried fetching laptop options"
      default: 0
    eligibility_check_retry_count:
      type: "integer"
      description: "Number of times we've retried checking eligibility"
      default: 0
    ticket_creation_retry_count:
      type: "integer"
      description: "Number of times we've retried creating a ticket"
      default: 0
    ticket_created:
      type: "boolean"
      description: "Whether ServiceNow ticket was created"
      default: false
    ticket_number:
      type: "string"
      description: "ServiceNow ticket number that was created"
      default: null
    user_wants_to_proceed:
      type: "boolean"
      description: "User's decision to proceed with process"
      default: null
    _should_return_to_routing:
      type: "boolean"
      description: "Flag to indicate task completion and return to routing agent"
      default: false

# State definitions
states:
  # State 1: Lookup Employee Information
  lookup_employee:
    type: "llm_processor"
    temperature: 0.3  # Factual lookup, should be consistent
    allowed_tools: [ "get_employee_laptop_info" ]
    prompt: |
      You are a helpful laptop refresh assistant.

      CRITICAL: DO NOT announce what you are about to do (e.g., "I will look up your information", "Let me check the database"). Execute tool calls silently and present only the results to the user.

      CRITICAL: Look up the laptop information for the authenticated user by using the get_employee_laptop_info tool.

      CRITICAL: You MUST include ALL laptop information EXACTLY as returned by get_employee_laptop_info. Do NOT summarize, do NOT omit any fields, do NOT reformat. Copy the COMPLETE output including all fields: Employee Name, Employee Location, Laptop Model, Laptop Serial Number, Laptop Purchase Date, Laptop Age, Laptop Warranty Expiry Date, Laptop Warranty.

      CRITICAL: If any values are missing in the tool output, keep them empty - do NOT invent values.

      If the user is not found, explain that their information was not found in the database.
    transitions:
      success: "classify_lookup_result"
    data_storage:
      employee_info: "llm_response"

  # State 1c: Classify Lookup Result
  classify_lookup_result:
    type: "llm_processor"
    temperature: 0.1  # Very deterministic classification
    uses_tools: "No"
    prompt: |
      Think step by step and use no tools
      Analyze this employee lookup response: "{employee_info.response}"

      Classify the result as SUCCESS, NOT_FOUND, or ERROR:
      - SUCCESS: if employee information was found (contains details like name, region, laptop model, etc.)
      - NOT_FOUND: if the employee ID was not found in the database
      - ERROR: if there was a system error or unclear response

      Respond with only the classification: SUCCESS, NOT_FOUND, or ERROR
    response_analysis:
      conditions:
        - name: "success"
          trigger_phrases: ["SUCCESS"]
          actions:
            - type: "transition"
              target: "check_eligibility"
        - name: "not_found"
          trigger_phrases: ["NOT_FOUND"]
          actions:
            - type: "add_message"
              message: "I'm sorry, your information was not found in our database. Please contact IT support for assistance."
            - type: "transition"
              target: "end"
        - name: "error"
          trigger_phrases: ["ERROR"]
          actions:
            - type: "add_message"
              message: "I encountered an issue looking up your information. Please try again or contact IT support."
            - type: "transition"
              target: "end"
      default_transition: "end"

  # State 2: Check Eligibility
  check_eligibility:
    type: "llm_processor"
    temperature: 0.4  # Mix of factual lookup + conversational response
    uses_mcp_tools: "No"
    prompt: |
      You have the employee information: {employee_info.response}

      Search the laptop refresh knowledge base for the company's laptop refresh policy and determine if this employee is eligible for a laptop replacement.

      CRITICAL: Do your calculations and reasoning silently. Do NOT show your work. Do NOT explain the calculation steps. Do NOT show "Now let's calculate..." or "Laptop Age in Months: (6 × 12) + 6 = 78 months" or similar explanations. Only output the final formatted response to the user.

      Steps (perform silently, do not show to user):
      1. Look up the corporate laptop refresh policy to find the refresh cycle/interval. You MUST retrieve the refresh interval from the knowledge base. Do NOT guess or assume.
      2. Convert both the laptop age and policy refresh interval to total months: laptop_age_months = (years × 12) + months, policy_months = (policy_years × 12). The laptop is ELIGIBLE if laptop_age_months >= policy_months, otherwise NOT ELIGIBLE. You must do the mathematical comparison correctly. If the laptop age in months is even 1 month less than the policy requirement in months, it is NOT ELIGIBLE.

      Your response to the user must follow this EXACT format:

      First, list all laptop details:
      - Employee Name: [from employee info]
      - Employee Location: [from employee info]
      - Laptop Model: [from employee info]
      - Laptop Serial Number: [from employee info]
      - Laptop Purchase Date: [from employee info]
      - Laptop Age: [from employee info]
      - Laptop Warranty Expiry Date: [from employee info]
      - Laptop Warranty: [from employee info]

      Then, state eligibility using EXACTLY one of these formats:

      If ELIGIBLE:
      Your laptop, a XXXXXXXX, was purchased on 20XX-XX-XX and is currently A years and B months old (X total months). The company's laptop refresh policy states that standard laptops will be refreshed every Y years (Z months) from the date of issuance. Since your laptop is Y years or older (X months >= Z months), you are eligible for a laptop refresh. Would you like to proceed with reviewing the available laptop options for your location?

      If NOT ELIGIBLE:
      Your laptop, a XXXXXXXX, was purchased on 20XX-XX-XX and is currently A years and B months old (X total months). The company's laptop refresh policy states that standard laptops will be refreshed every Y years (Z months) from the date of issuance. Since your laptop is less than Y years old (X months < Z months), you are not yet eligible for a laptop refresh. You may proceed anyway but the request for refresh may require additional approvals or be rejected. Would you like to proceed with reviewing the available laptop options for your location?

      CRITICAL: Do NOT include any calculation explanations, reasoning, or "thinking out loud" in your response. Only provide the formatted laptop details and eligibility statement above.
    transitions:
      success: "classify_eligibility_result"
    data_storage:
      laptop_eligibility: "llm_response"

  # State 2a: Classify Eligibility Result
  classify_eligibility_result:
    type: "llm_processor"
    temperature: 0.1  # Very deterministic classification
    uses_tools: "No"
    prompt: |
      Think step by step and use not tools
      This is the summary of the user's eligibility: "{laptop_eligibility.response}"

      If the response says the user is eligible for a laptop replacement, respond: ELIGIBLE
      If the response says the user is not eligible, respond: NOT
      If unclear, respond: UNCLEAR

      Respond with only one word: ELIGIBLE, NOT, or UNCLEAR
    response_analysis:
      conditions:
        - name: "eligible"
          trigger_phrases: ["ELIGIBLE"]
          actions:
            - type: "set_field"
              field_name: "eligibility_status"
              value: "ELIGIBLE"
            - type: "set_field"
              field_name: "eligibility_check_retry_count"
              value: 0
            - type: "add_message"
              message: "{laptop_eligibility.response}"
            - type: "transition"
              target: "waiting_proceed_confirmation"
        - name: "not_eligible"
          trigger_phrases: ["NOT"]
          actions:
            - type: "set_field"
              field_name: "eligibility_status"
              value: "NOT_ELIGIBLE"
            - type: "set_field"
              field_name: "eligibility_check_retry_count"
              value: 0
            - type: "add_message"
              message: "{laptop_eligibility.response}"
            - type: "transition"
              target: "waiting_ineligible_user_input"
        - name: "unclear_retry"
          trigger_phrases: ["UNCLEAR"]
          check_field: "eligibility_check_retry_count"
          check_value_less_than: 2
          actions:
            - type: "increment_field"
              field_name: "eligibility_check_retry_count"
            - type: "transition"
              target: "check_eligibility"
        - name: "unclear_max_retries"
          trigger_phrases: ["UNCLEAR"]
          actions:
            - type: "set_field"
              field_name: "eligibility_status"
              value: "UNCLEAR"
            - type: "add_message"
              message: "I'm having trouble determining your eligibility status. Please contact IT support for further assistance."
            - type: "transition"
              target: "end"
      default_transition: "end"

  # State 3: Waiting for Ineligible User Input
  waiting_ineligible_user_input:
    type: "waiting"
    transitions:
      user_input: "classify_ineligible_user_intent"

  # State 3a: Classify Ineligible User Intent
  classify_ineligible_user_intent:
    type: "intent_classifier"
    temperature: 0.2  # Deterministic intent classification
    uses_tools: "No"
    intent_prompt: |
      Analyze the user's message and determine their intent. The user said: "{user_input}"

      Context: This user is NOT currently eligible for a laptop replacement under standard policy.

      Classify the user's intent as one of the following:
      1. RETURN_TO_ROUTER - User wants to return to the routing agent or stop laptop refresh process (e.g., "return to router", "go back", "stop", "cancel laptop refresh")
      2. FAREWELL - User wants to end the conversation (goodbye, bye, thanks, etc.)
      3. PROCEED_ANYWAY - User wants to see laptop options despite being ineligible (proceed, show options, I want to see, etc.)
      4. GENERAL_QUESTION - User has questions about policy or general assistance

      Respond with only the classification: RETURN_TO_ROUTER, FAREWELL, PROCEED_ANYWAY, or GENERAL_QUESTION
    intent_actions:
      RETURN_TO_ROUTER:
        response: "task_complete_return_to_router"
        data_storage:
          _should_return_to_routing: true
        next_state: "end"
      FAREWELL:
        response: "Thank you for using the laptop refresh service. Have a great day!"
        data_storage:
          _should_return_to_routing: true
        next_state: "end"
      PROCEED_ANYWAY:
        response: "I understand you'd like to proceed. While you're not currently eligible under the standard policy, I can show you the available options. Please note that any request would need special approval and may be subject to additional justification requirements. Would you like to see the available laptop options?"
        data_storage:
          user_wants_to_proceed: true
        next_state: "select_laptop"
      GENERAL_QUESTION:
        prompt: |
          Previously retrieved information on laptop eligibility: {laptop_eligibility.response}

          The user said '{user_input}'. This user is NOT currently eligible for a laptop replacement under standard policy but is allowed to proceed anyway as long as they undertand that the request may be rejected or require additional approval. Provide a helpful response about laptop refresh policies or general assistance. If they're asking about their eligibility again, remind them they are not currently eligible and when they will become eligible.
        next_state: "waiting_ineligible_user_input"

  # State 4: Waiting for Proceed Confirmation
  waiting_proceed_confirmation:
    type: "waiting"
    transitions:
      user_input: "proceed_confirmation"

  # State 4a: Proceed Confirmation
  proceed_confirmation:
    type: "intent_classifier"
    temperature: 0.2  # Deterministic yes/no classification
    uses_tools: "No"
    intent_prompt: |
      CRITICAL: First check if the user wants to return to the router. ANY mention of "router", "go back", "return", or "stop" should be classified as RETURN_TO_ROUTER, even if they use polite language like "please".

      The user was asked if they want to proceed with reviewing laptop options. They responded: "{user_input}"

      Classify their response as one of the following:
      1. RETURN_TO_ROUTER - User wants to return to the routing agent or stop laptop refresh process (e.g., "return to router", "go back", "stop", "cancel laptop refresh")
      2. YES - User wants to proceed (yes, sure, okay, proceed, continue, etc.)
      3. NO - User does not want to proceed or wants to end conversation (no, cancel, stop, bye, etc.)
      4. UNCLEAR - Response is ambiguous or unclear

      Respond with only the classification: RETURN_TO_ROUTER, YES, NO, or UNCLEAR
    intent_actions:
      RETURN_TO_ROUTER:
        response: "task_complete_return_to_router"
        data_storage:
          _should_return_to_routing: true
        next_state: "end"
      "YES":
        next_state: "select_laptop"
        data_storage:
          user_wants_to_proceed: true
      "NO":
        response: "No problem! you will now be sent back to the router agent."
        data_storage:
          user_wants_to_proceed: false
          _should_return_to_routing: true
        next_state: "end"
      "UNCLEAR":
        response: "Please let me know if you'd like to proceed with reviewing the available laptop options (yes/no)."
        next_state: "waiting_proceed_confirmation"

  # State 5: Select Laptop
  select_laptop:
    type: "llm_processor"
    temperature: 0.2  # Mix of factual info + conversational presentation
    uses_mcp_tools: "No"
    conditional_prompts:
      - condition: "user_is_ineligible"
        check_field: "eligibility_status"
        check_phrases: ["NOT"]
        prompt: |
          Previously retrieved information on laptop eligibility: {laptop_eligibility.response}

          The user wants to see laptop options based on\n {employee_info.response}\n even though they are not currently eligible under standard policy.

          CRITICAL: DO NOT announce what you are about to do (e.g., "I will search the knowledge base", "Let me get the options"). Execute tool calls silently and present only the results to the user.

          Search the laptop refresh knowledge base and present them with all available laptop models based on their region.

          CRITICAL: You MUST retrieve and present EVERY specification field for EVERY laptop. The required fields are: Manufacturer, Model, ServiceNow Code, Target User, Cost, Operating System, Display Size, Display Resolution, Graphics Card, Minimum Storage, Weight, Ports, Minimum Processor, Minimum Memory, and Dimensions.

          CRITICAL: Do NOT summarize, abbreviate, or omit ANY specification details. Copy the COMPLETE specifications EXACTLY as retrieved from the knowledge base.

          CRITICAL: Preserve ALL characters and symbols EXACTLY as they appear in the knowledge base, including currency symbols.

          CRITICAL: Do NOT convert or substitute the ¥ symbol (Chinese Yuan) to ₩ (Korean Won) or any other currency symbol.

          CRITICAL: Only show laptops for their region. Do NOT show laptops from other regions. Do NOT use outside knowledge. Do NOT invent information.

          Use this exact format for each laptop:

          1. Model: XXXXX - ServiceNow Code: XXXXX
          - Manufacturer: XXXXX
          - Target User: XXXXX
          - Cost: XXXXX
          - Operating System: XXXXX
          - Display Size: XXXXX
          - Display Resolution: XXXXX
          - Graphics Card: XXXXX
          - Minimum Storage: XXXXX
          - Weight: XXXXX
          - Ports: XXXXX
          - Minimum Processor: XXXXX
          - Minimum Memory: XXXXX
          - Dimensions: XXXXX

          IMPORTANT: Include a warning that they are not currently eligible under standard policy and any request would require special approval and justification.

          Ask them to choose one specific laptop if they wish to proceed with a special request.
      - condition: "default"
        prompt: |
          The user wants to see their laptop options based on {employee_info.response}.

          CRITICAL: DO NOT announce what you are about to do (e.g., "I will search the knowledge base", "Let me get the options"). Execute tool calls silently and present only the results to the user.

          Search the laptop refresh knowledge base and present them with numbered list of all available laptop models based on their region.

          CRITICAL: You MUST retrieve and present EVERY specification field for EVERY laptop. The required fields are: Manufacturer, Model, ServiceNow Code, Target User, Cost, Operating System, Display Size, Display Resolution, Graphics Card, Minimum Storage, Weight, Ports, Minimum Processor, Minimum Memory, and Dimensions.

          CRITICAL: Do NOT summarize, abbreviate, or omit ANY specification details. Copy the COMPLETE specifications EXACTLY as retrieved from the knowledge base.

          CRITICAL: Preserve ALL characters and symbols EXACTLY as they appear in the knowledge base, including currency symbols.

          CRITICAL: Do NOT convert or substitute the ¥ symbol (Chinese Yuan) to ₩ (Korean Won) or any other currency symbol.

          CRITICAL: Only show laptops for their region. Do NOT show laptops from other regions. Do NOT use outside knowledge. Do NOT invent information.

          Use this exact format for each laptop:

          1. Model: XXXXX - ServiceNow Code: XXXXX
          - Manufacturer: XXXXX
          - Target User: XXXXX
          - Cost: XXXXX
          - Operating System: XXXXX
          - Display Size: XXXXX
          - Display Resolution: XXXXX
          - Graphics Card: XXXXX
          - Minimum Storage: XXXXX
          - Weight: XXXXX
          - Ports: XXXXX
          - Minimum Processor: XXXXX
          - Minimum Memory: XXXXX
          - Dimensions: XXXXX

          Ask them to choose one specific laptop.
    transitions:
      success: "validate_laptop_options"
    data_storage:
      laptop_options: "llm_response"

  # State 5a: Validate Laptop Options Response
  validate_laptop_options:
    type: "llm_processor"
    temperature: 0.1  # Very deterministic validation
    uses_tools: "No"
    suppress_response: true  # Don't show the VALID/INVALID output to the user
    prompt: |
      Think step by step and use no tools
      Analyze this laptop options response: "{laptop_options.response}"

      Determine if the response contains actual laptop options or if it's an error/announcement message.

      Check:
      1. Does the response contain multiple laptop models with specifications?
      2. Is this actual laptop data (not "I will search...", "Let me get...", error messages, or apologies)?

      If the response contains actual laptop options with specifications, respond: VALID
      If the response is an announcement, error message, or doesn't contain actual laptop data, respond: INVALID

      Respond with only one word: VALID or INVALID
    response_analysis:
      conditions:
        - name: "valid_options"
          trigger_phrases: ["VALID"]
          actions:
            - type: "set_field"
              field_name: "laptop_options_retry_count"
              value: 0
            - type: "add_message"
              message: "{laptop_options.response}"
            - type: "transition"
              target: "waiting_laptop_selection"
        - name: "invalid_options_retry"
          trigger_phrases: ["INVALID"]
          check_field: "laptop_options_retry_count"
          check_value_less_than: 2
          actions:
            - type: "increment_field"
              field_name: "laptop_options_retry_count"
            - type: "transition"
              target: "select_laptop"
        - name: "invalid_options_max_retries"
          trigger_phrases: ["INVALID"]
          actions:
            - type: "add_message"
              message: "I'm having trouble retrieving the laptop options from the knowledge base. Please try again later or contact IT support for assistance."
            - type: "transition"
              target: "end"
      default_transition: "select_laptop"

  # State 6: Waiting for Laptop Selection
  waiting_laptop_selection:
    type: "waiting"
    transitions:
      user_input: "classify_laptop_selection"

  # State 6a: Classify Laptop Selection
  classify_laptop_selection:
    type: "intent_classifier"
    temperature: 0.2  # Deterministic selection validation
    uses_tools: "No"
    intent_prompt: |
      The user said: "{user_input}"

      Based on the laptop options "{laptop_options.response}", determine their intent:
      - RETURN_TO_ROUTER: User wants to return to the routing agent or stop laptop refresh process (e.g., "return to router", "go back", "stop", "cancel laptop refresh")
      - VALID_SELECTION: User mentioned a specific laptop model, number, or clear selection
      - INVALID_SELECTION: User's choice is clearly invalid or nonsensical
      - UNCLEAR: User's response is unclear or doesn't contain a laptop selection

      Respond with only: RETURN_TO_ROUTER, VALID_SELECTION, INVALID_SELECTION, or UNCLEAR
    intent_actions:
      RETURN_TO_ROUTER:
        response: "task_complete_return_to_router"
        data_storage:
          _should_return_to_routing: true
        next_state: "end"
      "VALID_SELECTION":
        next_state: "confirm_laptop_selection"
        data_storage:
          selected_laptop: "{user_input}"
      "INVALID_SELECTION":
        response: "I don't see that option in the available laptop list. Please choose one of the specific laptop models I showed you earlier."
        next_state: "waiting_laptop_selection"
      "UNCLEAR":
        response: "Please specify which laptop model you'd like to select from the options I provided."
        next_state: "waiting_laptop_selection"

  # State 6b: Confirm Laptop Selection with Full Details
  confirm_laptop_selection:
    type: "llm_processor"
    temperature: 0.2  # Mix of factual lookup + conversational confirmation
    uses_tools: "No"
    prompt: |
      The user selected: "{selected_laptop}"

      From the following laptop options, find the details for the user's selection and provide them with the complete specifications:

      {laptop_options.response}

      CRITICAL: Do NOT create a ticket number. Do NOT mention any ticket numbers. Do NOT generate placeholder ticket numbers. No ticket has been created yet.

      Then ask them to confirm that is the correct laptop and that they would like you to create a Service Now ticket. CRITICAL do not ask for any information other than if they would like you to create the service now ticket.
    transitions:
      success: "waiting_ticket_confirmation"
    data_storage:
      selected_laptop_details: "llm_response"

  # State 7: Waiting for Ticket Confirmation
  waiting_ticket_confirmation:
    type: "waiting"
    transitions:
      user_input: "classify_ticket_confirmation"

  # State 7a: Classify Ticket Confirmation
  classify_ticket_confirmation:
    type: "intent_classifier"
    temperature: 0.2  # Deterministic yes/no classification
    uses_tools: "No"
    intent_prompt: |
      The user was asked if they want to create a ServiceNow ticket for their laptop refresh request. They responded: "{user_input}"

      Classify their response as one of the following:
      1. RETURN_TO_ROUTER - User wants to return to the routing agent or stop laptop refresh process (e.g., "return to router", "go back", "stop", "cancel laptop refresh")
      2. YES - User wants to create the ticket (yes, proceed, create, sure, okay, etc.)
      3. NO - User does not want to create the ticket (no, cancel, stop, etc.)
      4. UNCLEAR - Response is ambiguous or unclear

      Respond with only the classification: RETURN_TO_ROUTER, YES, NO, or UNCLEAR
    intent_actions:
      RETURN_TO_ROUTER:
        response: "task_complete_return_to_router"
        data_storage:
          _should_return_to_routing: true
        next_state: "end"
      "YES":
        next_state: "create_ticket"
        data_storage:
          ticket_created: true
      "NO":
        response: "No problem! you will now be sent back to the router agent."
        data_storage:
          _should_return_to_routing: true
        next_state: "end"
      "UNCLEAR":
        prompt: "The user said '{user_input}' when asked about creating a ticket. Ask them to clarify: do they want to create the ServiceNow ticket? (yes/no)"
        next_state: "waiting_ticket_confirmation"

  # State 8: Create Ticket
  create_ticket:
    type: "llm_processor"
    temperature: 0.3
    uses_tools: "Yes"
    allowed_tools: [ "open_laptop_refresh_ticket" ]
    prompt: |
      You have the employee information: {employee_info.response}
      Selected Laptop details: {selected_laptop_details}

      Create a ServiceNow ticket for the authenticated user by calling the open_laptop_refresh_ticket tool with these parameters:
      - employee_name: Extract the employee's name from the employee information above
      - business_justification: Use "agent submission"
      - servicenow_laptop_code: Extract the ServiceNow Code from the selected laptop details above

      CRITICAL: You must call the open_laptop_refresh_ticket TOOL (not try to call the laptop code as a tool). The laptop code is a PARAMETER to pass to the tool.

      EXAMPLE TOOL CALL:
      open_laptop_refresh_ticket(
        employee_name="XXXXXXXXXX",
        business_justification="agent submission",
        servicenow_laptop_code="YYYYYY"
      )

      After creating the ticket, respond to the user using EXACTLY this format (replace XXXXXX with the actual ticket number):

      A ServiceNow ticket for a laptop refresh has been created for you. The ticket number is XXXXXX. Your request will be processed by the IT Hardware Team, and you will receive updates via email as the ticket progresses.
      Is there anything else I can help you with?
    response_analysis:
      conditions:
        - name: "ticket_created_success"
          trigger_phrases: ["REQ"]
          actions:
            - type: "extract_data"
              pattern: "(REQ\\d+)"
              field_name: "ticket_number"
              source: "response"
            - type: "set_field"
              field_name: "ticket_creation_retry_count"
              value: 0
            - type: "transition"
              target: "waiting_post_ticket_input"
        - name: "ticket_creation_retry"
          trigger_phrases: [""]  # Match everything that didn't match REQ
          check_field: "ticket_creation_retry_count"
          check_value_less_than: 2
          actions:
            - type: "increment_field"
              field_name: "ticket_creation_retry_count"
            - type: "transition"
              target: "create_ticket"
        - name: "ticket_creation_max_retries"
          trigger_phrases: [""]  # Match everything after max retries
          actions:
            - type: "add_message"
              message: "I'm having trouble creating the ServiceNow ticket. Please contact IT support to manually create your laptop refresh request."
            - type: "transition"
              target: "end"
      default_transition: "end"

  # State 9: Waiting for Post-Ticket Input
  waiting_post_ticket_input:
    type: "waiting"
    transitions:
      user_input: "classify_post_ticket_intent"

  # State 9a: Classify Post-Ticket Intent
  classify_post_ticket_intent:
    type: "intent_classifier"
    temperature: 0.2  # Deterministic intent classification
    uses_tools: "No"
    intent_prompt: |
      The user was asked if there is anything else we can help with after creating a ticket. They responded: "{user_input}"

      Classify their response as one of the following:
      1. RETURN_TO_ROUTER - User wants to return to the routing agent or is done (e.g., "no", "no thanks", "that's all", "return to router", "go back")
      2. TICKET_NUMBER_REQUEST - User is asking for their ticket number (e.g., "what's my ticket number", "ticket number", "what ticket")
      3. GENERAL_QUESTION - User has additional questions or needs more help

      Respond with only the classification: RETURN_TO_ROUTER, TICKET_NUMBER_REQUEST, or GENERAL_QUESTION
    intent_actions:
      RETURN_TO_ROUTER:
        response: "task_complete_return_to_router"
        data_storage:
          _should_return_to_routing: true
        next_state: "end"
      TICKET_NUMBER_REQUEST:
        prompt: |
          The user is asking for their ticket number. Provide them with the ticket number: {ticket_number}

          Then ask if there is anything else you can help with.
        next_state: "waiting_post_ticket_input"
      GENERAL_QUESTION:
        prompt: |
          The user said: "{user_input}"

          Provide a helpful response to their question. You have access to the following information:
          - Employee info: {employee_info.response}
          - Laptop eligibility: {laptop_eligibility.response}
          - Selected laptop: {selected_laptop_details}
          - Ticket number: {ticket_number}

          After answering, ask if there is anything else you can help with.
        next_state: "waiting_post_ticket_input"

  # End state
  end:
    type: "terminal"
    reset_behavior:
      reset_state: "lookup_employee"  # Start with employee lookup using authoritative user ID
      clear_data:
        # System fields
        - "messages"
        - "current_state"
        # Business logic fields
        - "employee_info"
        - "laptop_eligibility"
        - "eligibility_status"
        - "selected_laptop"
        - "selected_laptop_details"
        - "laptop_options"
        - "ticket_created"
        - "ticket_number"
        - "user_wants_to_proceed"
        # Retry counters
        - "laptop_options_retry_count"
        - "eligibility_check_retry_count"
        - "ticket_creation_retry_count"
        # Internal state tracking
        - "_last_waiting_node"
        - "_last_processed_human_count"
        - "_consumed_this_invoke"
        # NOTE: _should_return_to_routing is NOT cleared here - it needs to persist
        # until the next request so the session manager can detect it and route back
