name: Auto-label trusted PRs for CI workflows

on:
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]

permissions:
  issues: write         # Need write to add/remove labels (labels use Issues API)
  pull-requests: write  # Need write for label operations on PRs

# Cancel any previous runs of this workflow for the same PR.
# This prevents race conditions when multiple events fire simultaneously
# (e.g., PR opened + synchronize + review submitted) 
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  auto-label:
    name: Auto-label trusted PRs
    runs-on: ubuntu-latest
    steps:
      - name: Remove safe-to-test label (reset state)
        uses: actions/github-script@v7
        with:
          script: |
            const label = 'safe-to-test';
            const prNumber = context.payload.pull_request.number;

            // Always remove the label first to ensure fresh state
            // This prevents false triggers if subsequent steps fail
            try {
              const labels = await github.rest.issues.listLabelsOnIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
              });

              const hasLabel = labels.data.some(l => l.name === label);

              if (hasLabel) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: label,
                });
                console.log(`üóëÔ∏è Removed label "${label}" from PR #${prNumber} (resetting state)`);
              } else {
                console.log(`‚ÑπÔ∏è Label "${label}" not present on PR #${prNumber}`);
              }
            } catch (error) {
              // Label might have been removed by another process, ignore
              console.log(`‚ÑπÔ∏è Could not check/remove label (may have been removed): ${error.message}`);
            }

      - name: Check if PR author is collaborator or has collaborator approval
        id: check_trusted
        # Check for collaborators (write/admin access) or collaborator approval
        # Both same-repo and fork PRs are treated the same way
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const prAuthor = context.payload.pull_request.user.login;
            
            // Check if PR author is a collaborator with write/admin access
            let isAuthorCollaborator = false;
            try {
              const collaborator = await github.rest.repos.checkCollaborator({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: prAuthor,
              });
              
              // Check permission level
              const permission = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: prAuthor,
              });
              
              if (['admin', 'write'].includes(permission.data.permission)) {
                isAuthorCollaborator = true;
                console.log(`‚úÖ PR author ${prAuthor} is a collaborator with ${permission.data.permission} access`);
                core.setOutput('shouldLabel', 'true');
                core.setOutput('reason', 'author_is_collaborator');
                return;
              }
            } catch (error) {
              console.log(`‚ÑπÔ∏è PR author ${prAuthor} is not a collaborator: ${error.message}`);
            }
            
            // For non-collaborator authors, check if PR has approval from a collaborator
            const reviews = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            
            // Get list of collaborators with write/admin access
            const collaborators = await github.rest.repos.listCollaborators({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            // Filter to only write/admin collaborators
            const trustedCollaborators = await Promise.all(
              collaborators.data.map(async (collab) => {
                try {
                  const permission = await github.rest.repos.getCollaboratorPermissionLevel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    username: collab.login,
                  });
                  return ['admin', 'write'].includes(permission.data.permission) ? collab.login.toLowerCase() : null;
                } catch {
                  return null;
                }
              })
            );

            const trustedCollaboratorSet = new Set(trustedCollaborators.filter(c => c !== null));

            // Check if any trusted collaborator has approved
            const approvedByCollaborator = reviews.data.some(review => {
              if (review.state !== 'APPROVED') return false;
              return trustedCollaboratorSet.has(review.user.login.toLowerCase());
            });

            if (approvedByCollaborator) {
              console.log(`‚úÖ PR has approval from a collaborator with write/admin access`);
              core.setOutput('shouldLabel', 'true');
              core.setOutput('reason', 'has_collaborator_approval');
              return;
            }
            
            // PR does not qualify - author is not a collaborator and no collaborator approval
            console.log(`‚ÑπÔ∏è PR does not qualify for auto-labeling (not collaborator, no collaborator approval)`);
            core.setOutput('shouldLabel', 'false');
            core.setOutput('reason', 'not_trusted');

      - name: Add safe-to-test label if PR qualifies
        uses: actions/github-script@v7
        with:
          script: |
            const label = 'safe-to-test';
            const prNumber = context.payload.pull_request.number;
            const shouldLabel = '${{ steps.check_trusted.outputs.shouldLabel }}' === 'true';
            const reason = '${{ steps.check_trusted.outputs.reason }}';
            
            // Add the label if PR qualifies
            // This ensures a 'labeled' event fires for dependent workflows
            if (shouldLabel) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: [label],
              });
              console.log(`‚úÖ Added label "${label}" to PR #${prNumber} (reason: ${reason})`);
            } else {
              console.log(`‚ÑπÔ∏è PR #${prNumber} does not qualify for label "${label}" (reason: ${reason})`);
            }

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.check_trusted.outputs.shouldLabel }}" = "true" ]; then
            echo "‚úÖ PR qualifies for 'safe-to-test' label"
            echo "Reason: ${{ steps.check_trusted.outputs.reason }}"
          else
            echo "‚ÑπÔ∏è PR does not qualify for 'safe-to-test' label"
            echo "Reason: ${{ steps.check_trusted.outputs.reason }}"
            echo ""
            echo "To trigger workflows that require secrets, the PR must:"
            echo "  - Be authored by a collaborator with write/admin access, OR"
            echo "  - Have approval from a collaborator with write/admin access"
          fi
