# Multi-stage build for MCP servers
# Build args must be defined before first FROM
ARG SERVICE_NAME
ARG MODULE_NAME

# Builder stage
FROM registry.access.redhat.com/ubi9/python-312:latest as builder

USER root
RUN pip3 install --no-cache-dir uv

WORKDIR /app

COPY tracing-config/ ./tracing-config

ARG SERVICE_NAME
WORKDIR /app/${SERVICE_NAME}

COPY ${SERVICE_NAME}/ .
RUN uv sync --frozen --no-cache

# Production stage
FROM registry.access.redhat.com/ubi9/python-312-minimal:latest

WORKDIR /app

COPY --from=builder /app/tracing-config /app/tracing-config

ARG SERVICE_NAME
# Copy virtual environment from builder
COPY --from=builder /app/${SERVICE_NAME}/.venv /app/.venv

# Copy application source
ARG MODULE_NAME
COPY ${SERVICE_NAME}/src/ ./src/
COPY ${SERVICE_NAME}/pyproject.toml ./

# Set environment variables
ENV PATH="/app/.venv/bin:$PATH"
ENV PYTHONPATH="/app/src:/app/tracing-config/src:$PYTHONPATH"
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV OTEL_SERVICE_NAME=${SERVICE_NAME}
ENV OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED=true

# Set the module name as an environment variable so it can be used in CMD
ENV MODULE_NAME=${MODULE_NAME}

# Drop privileges
USER 1001

# Expose port (MCP servers typically use different ports)
EXPOSE 8000

# Run the MCP server
CMD python src/$(echo $MODULE_NAME | sed 's/\./\//').py
