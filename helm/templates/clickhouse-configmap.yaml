{{- if .Values.langfuse.enabled }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "self-service-agent.fullname" . }}-clickhouse-config
  labels:
    {{- include "self-service-agent.labels" . | nindent 4 }}
    app.kubernetes.io/component: clickhouse
data:
  custom.xml: |
    <clickhouse>
      <logger>
        <level>information</level>
        <log>/var/log/clickhouse-server/clickhouse-server.log</log>
        <errorlog>/var/log/clickhouse-server/clickhouse-server.err.log</errorlog>
        <size>1000M</size>
        <count>10</count>
      </logger>

      <!-- Listen on all interfaces for pod networking -->
      <listen_host>::</listen_host>

      <!-- Server-level performance tuning -->
      <max_concurrent_queries>100</max_concurrent_queries>
      <max_connections>1024</max_connections>
      <keep_alive_timeout>3</keep_alive_timeout>

      <!-- Compression settings for better storage efficiency -->
      <compression>
        <case>
          <min_part_size>10485760</min_part_size>
          <min_part_size_ratio>0.01</min_part_size_ratio>
          <method>lz4</method>
        </case>
      </compression>
    </clickhouse>
{{- end }}
