# Multi-stage build for Python services
# Build args must be defined before first FROM
ARG SERVICE_NAME
ARG MODULE_NAME
ARG BUILD_CONTEXT=.
ARG USE_PIP_INSTALL=false
ARG UV_VERSION=0.8.9

# Builder stage
FROM registry.access.redhat.com/ubi9/python-312:latest as builder

USER root
# Install uv version (defaults to 0.8.9 to match CI, can be overridden via --build-arg UV_VERSION=<version>)
ARG UV_VERSION
RUN pip3 install --no-cache-dir uv==${UV_VERSION}

WORKDIR /app

# Copy shared database if needed (most services need it)
COPY shared-models ./shared-models/

# Copy mock-employee-data dependency
COPY mock-employee-data/ ./mock-employee-data/

# Copy shared clients package
COPY shared-clients ./shared-clients/

# Copy agent-service (needed by request-manager and integration-dispatcher)
COPY agent-service ./agent-service/
COPY test ./test/

COPY tracing-config/ ./tracing-config

# Copy service files
# Copy pyproject.toml and dependency files (both uv.lock and requirements.txt should exist)
# We copy both files, then use conditional logic in RUN to decide which method to use
ARG SERVICE_NAME
ARG USE_PIP_INSTALL
COPY ${SERVICE_NAME}/pyproject.toml ${SERVICE_NAME}/uv.lock ${SERVICE_NAME}/requirements.txt ./${SERVICE_NAME}/
WORKDIR /app/${SERVICE_NAME}

# Conditional dependency installation: USE_PIP_INSTALL=true uses pip (workaround for QEMU on Mac M1)
# Default: uv sync (faster). When USE_PIP_INSTALL=true: pip install from requirements.txt with hash verification
RUN if [ "$USE_PIP_INSTALL" = "true" ]; then \
        # Install editable packages first (without --require-hashes), then external packages with hash verification
        python3 -m venv .venv && \
        grep -E "^(-e |\.\./)" requirements.txt | grep -v "^#" > /tmp/editable-requirements.txt 2>/dev/null || true && \
        grep -vE "^(-e |\.\./)" requirements.txt | grep -v "^#" > /tmp/non-editable-requirements.txt && \
        if [ -s /tmp/editable-requirements.txt ]; then \
            .venv/bin/pip install --no-cache-dir --no-deps -r /tmp/editable-requirements.txt; \
        fi && \
        .venv/bin/pip install --no-cache-dir --require-hashes --extra-index-url https://download.pytorch.org/whl/cpu -r /tmp/non-editable-requirements.txt && \
        rm -f /tmp/*-requirements.txt; \
    else \
        # Default: Use uv sync (faster and more reliable)
        uv sync --frozen --no-cache --no-dev; \
    fi

# Production stage
FROM registry.access.redhat.com/ubi9/python-312-minimal:latest

WORKDIR /app

# Copy shared database if needed
COPY --from=builder /app/shared-models /app/shared-models

# Copy mock-employee-data dependency
COPY --from=builder /app/mock-employee-data /app/mock-employee-data

# Copy shared clients package
COPY --from=builder /app/shared-clients /app/shared-clients

# Copy agent-service (needed by request-manager and integration-dispatcher)
COPY --from=builder /app/agent-service /app/agent-service
COPY --from=builder /app/test /app/test

COPY --from=builder /app/tracing-config /app/tracing-config

# Copy virtual environment from builder (service-specific, but ARG not needed yet)
ARG SERVICE_NAME
ENV OTEL_SERVICE_NAME=${SERVICE_NAME}
ENV OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED=true
COPY --from=builder /app/${SERVICE_NAME}/.venv /app/.venv

# Copy application source
ARG MODULE_NAME
COPY ${SERVICE_NAME}/src/ ./src/
COPY ${SERVICE_NAME}/pyproject.toml ./

# Set environment variables
# Use system python3 with venv site-packages on PYTHONPATH so uvicorn etc. are found regardless of
# which interpreter path is used (e.g. /opt/app-root/bin/python3 in ubi9/python-312-minimal).
# Required when USE_PIP_INSTALL=true (venv's bin/python points at builder path that does not exist here).
ENV VIRTUAL_ENV=/app/.venv
ENV PATH="/usr/bin:${VIRTUAL_ENV}/bin:$PATH"
ENV PYTHONPATH="/usr/lib64/python3.12:${VIRTUAL_ENV}/lib/python3.12/site-packages:/app/agent-service/src:/app/shared-models/src:/app/shared-clients/src:/app/src:/app/tracing-config/src:$PYTHONPATH"
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Set the module name as an environment variable so it can be used in CMD
ENV MODULE_NAME=${MODULE_NAME}

# Create HuggingFace cache directory with proper permissions (for services that need it)
USER root
RUN mkdir -p /app/.cache/huggingface/transformers && \
    chmod -R 775 /app/.cache && \
    chown -R 1001:0 /app/.cache
USER 1001

# HuggingFace environment variables (safe for all services, only used if needed)
ENV HF_HOME="/app/.cache/huggingface"
ENV TRANSFORMERS_CACHE="/app/.cache/huggingface/transformers"

# Expose port
EXPOSE 8080

# Run the application (python3 uses system interpreter; VIRTUAL_ENV ensures venv site-packages are loaded)
# Support optional UVICORN_WORKERS environment variable for multi-process concurrency
CMD if [ -n "$UVICORN_WORKERS" ]; then \
      python3 -m uvicorn $MODULE_NAME:app --host 0.0.0.0 --port 8080 --workers $UVICORN_WORKERS; \
    else \
      python3 -m uvicorn $MODULE_NAME:app --host 0.0.0.0 --port 8080; \
    fi
